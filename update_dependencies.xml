<!--
  ~ Copyright 2000-2012 JetBrains s.r.o.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<project name="Update Dependencies" default="update">
    <property name="build.zip" value="kotlin.zip"/>
    <property name="plugin.build.zip" value="kotlin-plugin.zip"/>

    <target name="update_kotlin">
        <execute_update/>
    </target>

    <!--<target name="jb_update">
        <execute_update teamcity="http://buildserver.labs.intellij.net" teamcity.build="bt662"/>
    </target>-->

    <macrodef name="execute_update">
        <attribute name="teamcity" default="http://teamcity.jetbrains.com"/>
        <attribute name="teamcity.build" default="bt344"/>
        <attribute name="teamcity.plugin.build" default="bt345"/>
        <sequential>
            <property name="tc.main" value="@{teamcity}/guestAuth/repository/download/@{teamcity.build}/.lastSuccessful"/>
            <property name="tc.plugin" value="@{teamcity}/guestAuth/repository/download/@{teamcity.plugin.build}/.lastSuccessful"/>

            <property name="path.to.kotlin" value="lib/kotlinc"/>
            <property name="path.to.kotlin.plugin" value="lib/kotlin-plugin"/>

            <delete dir="${path.to.kotlin}" failonerror="false"/>

            <get src="${tc.main}/kotlin-{build.number}.zip" dest="${build.zip}" />
            <unzip src="${build.zip}" dest="lib"/>
            <delete file="${build.zip}"/>
            <delete dir="${path.to.kotlin}/examples"/>


            <loadfile srcfile="${path.to.kotlin}/build.txt" property="version"/>

            <replaceregexp file="kotlin.web.demo.core/src/org/jetbrains/webdemo/server/ServerSettings.java"
                           match="KOTLIN_VERSION = &#34;(.*[0-9]).(.*[0-9]).(.*[0-9])&#34;"
                           replace="KOTLIN_VERSION = &#34;${version}&#34;"
                           byline="true"/>
            <replaceregexp file="kotlin.web.demo.server/static/components/common.js"
                           match="KOTLIN_VERSION = &#34;(.*[0-9]).(.*[0-9]).(.*[0-9])&#34;"
                           replace="KOTLIN_VERSION = &#34;${version}&#34;"
                           byline="true"/>

            <get src="${tc.plugin}/kotlin-plugin-{build.number}.zip" dest="${plugin.build.zip}" />

            <unzip src="${plugin.build.zip}" dest="${path.to.kotlin.plugin}"/>
            <delete file="${plugin.build.zip}"/>
            <delete dir="${path.to.kotlin.plugin}/Kotlin/kotlinc"/>
        </sequential>
    </macrodef>
</project>
